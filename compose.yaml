name: waygrid-router

volumes:
  waygrid_kafka_data_1: { }
  waygrid_kafka_data_2: { }
  waygrid_kafka_data_3: { }
  waygrid_redis_data_1: { }
  waygrid_redis_data_2: { }
  waygrid_redis_data_3: { }
  waygrid_redisinsight_data: { }

x-kafka-cluster-base: &kafka-cluster-base
  image: bitnamilegacy/kafka:latest

x-redis-cluster-base: &redis-cluster-base
  image: bitnamilegacy/redis-cluster:latest

services:
  kafka-node-1:
    <<: *kafka-cluster-base
    hostname: kafka-node-1
    container_name: kafka-node-1
    volumes:
      - waygrid_kafka_data_1:/var/lib/kafka/data
    user: root
    ports:
      #      - '9092:9092'
      - '29092:29092'
    environment:
      - KAFKA_ENABLE_KRAFT=yes
      - KAFKA_CFG_PROCESS_ROLES=broker,controller
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093,PLAINTEXT_HOST://:29092
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://kafka-node-1:9092,PLAINTEXT_HOST://localhost:29092
      - KAFKA_CFG_NODE_ID=1
      - KAFKA_BROKER_ID=1
      - KAFKA_KRAFT_CLUSTER_ID=LelM2dIFQkiUFvXCEcqRWA
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=1@kafka-node-1:9093,2@kafka-node-2:9095,3@kafka-node-3:9097
      - ALLOW_PLAINTEXT_LISTENER=yes
    labels:
      - dev.orbstack.domains=kafka-node-1.router.waygrid.local
      - dev.orbstack.http-port=29092

  kafka-node-2:
    <<: *kafka-cluster-base
    hostname: kafka-node-2
    container_name: kafka-node-2
    volumes:
      - waygrid_kafka_data_2:/var/lib/kafka/data
    user: root
    ports:
      #      - '9094:9094'
      - '29094:29094'
    environment:
      - KAFKA_ENABLE_KRAFT=yes
      - KAFKA_CFG_PROCESS_ROLES=broker,controller
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9094,CONTROLLER://:9095,PLAINTEXT_HOST://:29094
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://kafka-node-2:9094,PLAINTEXT_HOST://localhost:29094
      - KAFKA_CFG_NODE_ID=2
      - KAFKA_BROKER_ID=2
      - KAFKA_KRAFT_CLUSTER_ID=LelM2dIFQkiUFvXCEcqRWA
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=1@kafka-node-1:9093,2@kafka-node-2:9095,3@kafka-node-3:9097
      - ALLOW_PLAINTEXT_LISTENER=yes
    labels:
      - dev.orbstack.domains=kafka-node-2.router.waygrid.local
      - dev.orbstack.http-port=29094

  kafka-node-3:
    <<: *kafka-cluster-base
    hostname: kafka-node-3
    container_name: kafka-node-3
    volumes:
      - waygrid_kafka_data_3:/var/lib/kafka/data
    user: root
    ports:
      #      - '9096:9096'
      - '29096:29096'
    environment:
      - KAFKA_ENABLE_KRAFT=yes
      - KAFKA_CFG_PROCESS_ROLES=broker,controller
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9096,CONTROLLER://:9097,PLAINTEXT_HOST://:29096
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://kafka-node-3:9096,PLAINTEXT_HOST://localhost:29096
      - KAFKA_CFG_NODE_ID=3
      - KAFKA_BROKER_ID=3
      - KAFKA_KRAFT_CLUSTER_ID=LelM2dIFQkiUFvXCEcqRWA
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=1@kafka-node-1:9093,2@kafka-node-2:9095,3@kafka-node-3:9097
      - ALLOW_PLAINTEXT_LISTENER=yes
    labels:
      - dev.orbstack.domains=kafka-node-3.router.waygrid.local
      - dev.orbstack.http-port=29096

  schema-registry:
    image: confluentinc/cp-schema-registry:7.6.0
    hostname: schema-registry
    container_name: schema-registry
    depends_on:
      - kafka-node-1
      - kafka-node-2
      - kafka-node-3
    ports:
      - "8081:8081"
    environment:
      SCHEMA_REGISTRY_HOST_NAME: schema-registry
      SCHEMA_REGISTRY_KAFKASTORE_BOOTSTRAP_SERVERS: kafka-node-1:9092,kafka-node-2:9094,kafka-node-3:9096
      SCHEMA_REGISTRY_LISTENERS: http://0.0.0.0:8081
    labels:
      - dev.orbstack.domains=schema-registry.router.waygrid.local
      - dev.orbstack.http-port=8081

  redpanda:
    image: docker.redpanda.com/redpandadata/console:latest
    hostname: redpanda
    container_name: redpanda
    depends_on:
      - kafka-node-1
      - kafka-node-2
      - kafka-node-3
      - schema-registry
    #    ports:
    #      - "1336:8080"
    volumes:
      - ./infra/redpanda-console.yaml:/etc/redpanda-console/config.yaml:ro
    environment:
      CONFIG_FILEPATH: /etc/redpanda-console/config.yaml
    labels:
      - dev.orbstack.domains=redpanda.router.waygrid.local
      - dev.orbstack.http-port=8080

  redis-node-1:
    <<: *redis-cluster-base
    hostname: redis-node-1
    container_name: redis-node-1
    volumes:
      - waygrid_redis_data_1:/bitnami/redis/data
    depends_on:
      - redis-node-2
      - redis-node-3
    ports:
      - '6379:6379'
    environment:
      - 'ALLOW_EMPTY_PASSWORD=yes'
      - 'REDIS_CLUSTER_REPLICAS=0'
      - 'REDIS_CLUSTER_CREATOR=yes'
      - 'REDIS_NODES=redis-node-1 redis-node-2 redis-node-3'

  redis-node-2:
    <<: *redis-cluster-base
    hostname: redis-node-2
    container_name: redis-node-2
    volumes:
      - waygrid_redis_data_2:/bitnami/redis/data
    ports:
      - '6380:6379'
    environment:
      - 'ALLOW_EMPTY_PASSWORD=yes'
      - 'REDIS_NODES=redis-node-1 redis-node-2 redis-node-3'

  redis-node-3:
    <<: *redis-cluster-base
    hostname: redis-node-3
    container_name: redis-node-3
    volumes:
      - waygrid_redis_data_3:/bitnami/redis/data
    ports:
      - '6381:6379'
    environment:
      - 'ALLOW_EMPTY_PASSWORD=yes'
      - 'REDIS_NODES=redis-node-1 redis-node-2 redis-node-3'

  redisinsight:
    image: redis/redisinsight
    hostname: redisinsight
    container_name: redisinsight
    volumes:
      - waygrid_redisinsight_data:/data
    depends_on:
      - redis-node-1
      - redis-node-2
      - redis-node-3
    #    ports:
    #      - "5540:5540"
    labels:
      - dev.orbstack.domains=redisinsight.router.waygrid.local
      - dev.orbstack.http-port=5540

  otel-lgtm:
    image: grafana/otel-lgtm
    hostname: otel-lgtm
    container_name: otel-lgtm
    ports:
      #        - "3000:3000"
      - "4317:4317"
      - "4318:4318"
    environment :
      - OTEL_METRIC_EXPORT_INTERVAL=500
    labels:
      - dev.orbstack.domains=grafana.router.waygrid.local
      - dev.orbstack.http-port=3000

  admin-ui:
    build:
      context: ./modules/admin/ui
      dockerfile: Dockerfile
      target: development
    hostname: admin-ui
    container_name: admin-ui
    volumes:
      - ./modules/admin/ui/src:/app/src:ro
      - ./modules/admin/ui/public:/app/public:ro
    environment:
      - VITE_TOPOLOGY_URL=http://system-topology:1337
      - VITE_WAYSTATION_URL=http://system-waystation:1337
      - VITE_SCHEDULER_URL=http://system-scheduler:1337
      - VITE_IAM_URL=http://system-iam:1337
      - VITE_HISTORY_URL=http://system-history:1337
      - VITE_DAG_REGISTRY_URL=http://system-dag-registry:1337
      - VITE_SECURE_STORE_URL=http://system-secure-store:1337
      - VITE_BILLING_URL=http://system-billing:1337
      - VITE_KMS_URL=http://system-kms:1337
      - VITE_BLOB_STORE_URL=http://system-blob-store:1337
      - VITE_ORIGIN_HTTP_URL=http://origin-http:1337
    labels:
      - dev.orbstack.domains=admin.router.waygrid.local
      - dev.orbstack.http-port=3000
    depends_on:
      - kafka-node-1
      - redis-node-1
