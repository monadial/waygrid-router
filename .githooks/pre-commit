#!/usr/bin/env bash
# =============================================================================
# Waygrid Router - Pre-commit Hook
# =============================================================================
#
# This hook runs before each commit to ensure code quality:
#   1. Auto-formats code with scalafmt
#   2. Auto-fixes linting issues with scalafix
#   3. Re-stages any auto-fixed files
#
# To install: Run `./scripts/setup-hooks.sh` or manually:
#   git config core.hooksPath .githooks
#
# To bypass (use sparingly): git commit --no-verify
#
# =============================================================================

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}  Waygrid Pre-commit Hook${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

# Get list of staged Scala files
STAGED_SCALA_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.scala$|\.sbt$' || true)

if [ -z "$STAGED_SCALA_FILES" ]; then
    echo -e "${GREEN}âœ“ No Scala files staged, skipping checks${NC}"
    exit 0
fi

echo -e "${YELLOW}ğŸ“ Staged Scala files:${NC}"
echo "$STAGED_SCALA_FILES" | sed 's/^/   /'
echo ""

# Track if we need to re-stage files
RESTAGE_NEEDED=false

# =============================================================================
# Step 1: Auto-format with scalafmt
# =============================================================================
echo -e "${YELLOW}ğŸ¨ Running scalafmt (auto-fix)...${NC}"

if sbt scalafmtAll 2>&1 | tail -5; then
    echo -e "${GREEN}âœ“ Formatting complete${NC}"
else
    echo -e "${RED}âœ— Formatting failed${NC}"
    exit 1
fi

# Check if any staged files were modified by scalafmt
for file in $STAGED_SCALA_FILES; do
    if [ -f "$file" ]; then
        # Check if file was modified after staging
        if ! git diff --quiet "$file" 2>/dev/null; then
            echo -e "${YELLOW}   â†’ Auto-formatted: $file${NC}"
            RESTAGE_NEEDED=true
        fi
    fi
done

echo ""

# =============================================================================
# Step 2: Auto-fix linting with scalafix
# =============================================================================
echo -e "${YELLOW}ğŸ” Running scalafix (auto-fix)...${NC}"

if sbt scalafixAll 2>&1 | tail -5; then
    echo -e "${GREEN}âœ“ Linting complete${NC}"
else
    echo -e "${RED}âœ— Linting failed${NC}"
    exit 1
fi

# Check if any staged files were modified by scalafix
for file in $STAGED_SCALA_FILES; do
    if [ -f "$file" ]; then
        if ! git diff --quiet "$file" 2>/dev/null; then
            echo -e "${YELLOW}   â†’ Auto-fixed: $file${NC}"
            RESTAGE_NEEDED=true
        fi
    fi
done

echo ""

# =============================================================================
# Step 3: Re-stage auto-fixed files
# =============================================================================
if [ "$RESTAGE_NEEDED" = true ]; then
    echo -e "${YELLOW}ğŸ“¦ Re-staging auto-fixed files...${NC}"
    for file in $STAGED_SCALA_FILES; do
        if [ -f "$file" ]; then
            git add "$file"
            echo -e "${GREEN}   âœ“ Re-staged: $file${NC}"
        fi
    done
    echo ""
fi

# =============================================================================
# Step 4: Final verification (check mode)
# =============================================================================
echo -e "${YELLOW}ğŸ” Final verification...${NC}"

# Verify formatting
if ! sbt scalafmtCheckAll 2>&1 | tail -3; then
    echo -e "${RED}âœ— Formatting verification failed${NC}"
    echo -e "${RED}  Please run 'sbt scalafmtAll' and try again${NC}"
    exit 1
fi

# Verify linting
if ! sbt 'scalafixAll --check' 2>&1 | tail -3; then
    echo -e "${RED}âœ— Linting verification failed${NC}"
    echo -e "${RED}  Please run 'sbt scalafixAll' and try again${NC}"
    exit 1
fi

echo ""
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}  âœ“ All pre-commit checks passed!${NC}"
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

exit 0
